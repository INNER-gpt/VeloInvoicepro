<meta name='viewport' content='width=device-width, initial-scale=1'/><!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pro Invoice Generator - Professional PDF Invoices</title>
  <meta name="description" content="Free professional invoice generator. Create beautiful PDF invoices with logo, unlimited items, multi-currency. Upgrade to Premium.">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --primary:#0f62fe;
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#64748b;
      --accent:#0f766e;
      --radius:14px;
      --shadow: 0 10px 30px rgba(2,6,23,0.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:linear-gradient(180deg,#f6f8fb 0%, #eef3fb 100%);
      margin:0; padding:28px; color:#0f172a;
      -webkit-font-smoothing:antialiased;
    }

    /* Container */
    .wrap{max-width:1100px;margin:0 auto;min-height:calc(100vh - 56px);display:flex;align-items:flex-start;gap:20px;flex-direction:column}
    .invoice-card{
      background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:28px;width:100%;
      transition:transform .18s, box-shadow .18s; overflow:hidden;
    }
    .invoice-card.fullscreen{border-radius:0; padding:28px; height:100vh; overflow:auto;}

    /* Header */
    .header{display:flex;gap:18px;align-items:flex-start; justify-content:space-between; border-bottom:1px solid #eef2f7;padding-bottom:18px;margin-bottom:20px}
    .company{flex:1;min-width:0}
    .company input[type="text"]{font-size:22px;font-weight:700;color:var(--primary);width:100%;border:none;background:transparent;outline:none}
    .company textarea{width:100%;border:none;background:transparent;color:var(--muted);resize:none;font-family:inherit;padding-top:6px}
    .company .phone-row{display:flex;gap:8px;align-items:center;margin-top:8px}
    .company .phone-row input{padding:8px;border-radius:8px;border:1px solid #e6eef7;width:220px}

    .logo-area{width:160px;height:110px;border-radius:12px;border:1.5px dashed #e3eefb;background:#fbfeff;display:flex;align-items:center;justify-content:center;flex-direction:column;cursor:pointer;position:relative;padding:8px}
    .logo-area img{max-width:100%;max-height:100%;object-fit:contain;border-radius:8px}
    .logo-text{font-size:12px;color:var(--muted);text-align:center}
    .logo-badge{font-size:11px;color:#f59e0b;margin-top:6px}

    /* Details */
    .grid{display:grid;grid-template-columns:1fr 320px;gap:20px;margin-top:12px}
    .label{font-size:11px;text-transform:uppercase;color:#93a0b3;font-weight:700;margin-bottom:8px}
    .meta input,.meta select,.client textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #eef4fb;background:#fff;font-family:inherit}
    .client textarea{height:120px;resize:vertical}

    /* Items table */
    table{width:100%;border-collapse:collapse;margin-top:18px}
    th{background:#fafbfc;padding:12px;text-align:left;font-weight:600;color:#344155;border-bottom:1px solid #eef4fb}
    td{padding:10px;border-bottom:1px solid #f3f6fb;vertical-align:middle}
    td input{width:100%;padding:8px;border-radius:8px;border:1px solid transparent;background:#fff;font-family:inherit}
    td .small{width:80px}
    .row-actions button{background:none;border:none;color:#ff5864;cursor:pointer;font-weight:600}

    .add-line{margin-top:12px;padding:10px 14px;border-radius:10px;border:1px solid #e6eef7;background:#fff;cursor:pointer;color:#164e63}

    /* totals & actions */
    .bottom{display:flex;justify-content:space-between;align-items:center;margin-top:22px;gap:12px;flex-wrap:wrap}
    .totals{width:320px;background:linear-gradient(180deg,#fff,#fbfdff);border-radius:10px;padding:14px;border:1px solid #eef4fb}
    .totals .row{display:flex;justify-content:space-between;padding:8px 0;color:#253244}
    .grand{display:flex;justify-content:space-between;padding-top:10px;border-top:1px dashed #eef4fb;font-weight:700;font-size:18px;color:var(--primary)}

    .actions{display:flex;gap:10px;align-items:center}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-outline{background:#fff;border:1px solid #e6eef7;color:#144b7a}

    /* modal */
    #paymentModal{display:none;position:fixed;inset:0;background:rgba(3,7,18,.55);align-items:center;justify-content:center;z-index:1200;padding:20px}
    #paymentModal.show{display:flex}
    .modal{width:520px;max-width:100%;background:#fff;border-radius:12px;padding:22px;box-shadow:0 30px 80px rgba(2,6,23,0.2)}
    .modal h3{margin:0 0 8px 0}
    .pm-choices{display:flex;gap:8px;margin-top:10px}
    .card-form input{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #eef4fb}

    /* phone fullscreen overlay */
    #phoneOverlay{display:none;position:fixed;inset:0;background:linear-gradient(180deg, rgba(2,6,23,.9), rgba(2,6,23,.95));z-index:1300;align-items:center;justify-content:center;flex-direction:column;color:#fff}
    #phoneOverlay.show{display:flex}
    #phoneOverlay .num{font-size:64px;font-weight:800;letter-spacing:1px;margin-bottom:12px}
    #phoneOverlay .hint{opacity:.85}

    /* responsive */
    @media (max-width:920px){
      .grid{grid-template-columns:1fr}
      .header{flex-direction:column;align-items:stretch;gap:12px}
      .logo-area{width:100%;height:86px}
      .company .phone-row input{width:100%}
      .totals{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="invoice-card" id="invoiceCard" role="main" aria-label="Invoice generator card">
      <div class="header">
        <div class="company">
          <input id="companyName" placeholder="Åžirket AdÄ±" value="Example Inc." />
          <textarea id="companyAddress" placeholder="Adres, Vergi No, e-posta...">123 Business St, New York, NY 10001
Tax ID: 12-3456789</textarea>

          <div class="phone-row">
            <input id="companyPhone" placeholder="Telefon (opsiyonel)" />
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)">
              <input id="showCompanyPhoneOnPdf" type="checkbox" style="width:16px;height:16px" checked> PDF'ye ekle
            </label>
            <button class="btn" id="showCompanyPhoneBtn" title="Telefonu tam ekran gÃ¶ster" style="margin-left:auto">ðŸ“ž Tam Ekran</button>
          </div>
        </div>

        <div class="logo-area" id="logoArea" title="Logo (Premium)">
          <img id="logoPreview" style="display:none" alt="Logo preview">
          <div id="logoPlaceholder">
            <div style="font-size:28px">ðŸ“·</div>
            <div class="logo-text">Add Logo</div>
            <div class="logo-badge" id="logoBadge">(Premium)</div>
          </div>
          <input id="logoInput" type="file" accept="image/*" style="display:none" />
        </div>
      </div>

      <div class="grid">
        <div>
          <div class="client">
            <div class="label">Bill To</div>
            <textarea id="clientInfo" placeholder="MÃ¼ÅŸteri ismi, ÅŸirket ve adres..."></textarea>
            <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
              <input id="clientPhone" placeholder="MÃ¼ÅŸteri Telefonu (opsiyonel)" style="padding:8px;border-radius:8px;border:1px solid #eef4fb" />
              <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)">
                <input id="showClientPhoneOnPdf" type="checkbox" style="width:16px;height:16px" checked> PDF'ye ekle
              </label>
              <button class="btn" id="showClientPhoneBtn" title="Telefonu tam ekran gÃ¶ster">ðŸ“ž Tam Ekran</button>
            </div>
          </div>
        </div>

        <div class="meta">
          <div class="label">Invoice Details</div>
          <input id="invoiceNo" placeholder="Invoice No" value="INV-2025-001" />
          <div style="margin-top:12px">
            <div class="label" style="margin-bottom:6px">Invoice Date</div>
            <input id="invoiceDate" type="date" />
          </div>

          <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
            <div style="flex:1">
              <div class="label" style="margin-bottom:6px">Currency</div>
              <select id="currency" style="padding:10px;border-radius:8px;border:1px solid #eef4fb;width:100%">
                <option value="USD">$ USD - US Dollar</option>
                <option value="EUR">â‚¬ EUR - Euro</option>
                <option value="GBP">Â£ GBP - British Pound</option>
                <option value="CAD">$ CAD - Canadian Dollar</option>
                <option value="AUD">$ AUD - Australian Dollar</option>
              </select>
            </div>
            <div style="width:120px">
              <div class="label" style="margin-bottom:6px">Tax %</div>
              <input id="taxRate" type="number" min="0" step="0.1" value="0" style="padding:10px;border-radius:8px;border:1px solid #eef4fb;width:100%"/>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <button class="btn btn-outline" id="addLineBtn">+ Add Line</button>
            <button class="btn btn-outline" id="toggleFullscreenBtn">Tam Ekran</button>
            <button class="btn btn-primary" id="activatePremiumBtn" style="margin-left:auto">Premium AktifleÅŸtir</button>
          </div>
        </div>
      </div>

      <table id="itemsTable" aria-label="Invoice items">
        <thead>
          <tr><th style="width:48%">DESCRIPTION</th><th style="width:12%">QTY</th><th style="width:20%">UNIT PRICE</th><th style="width:12%;text-align:right">AMOUNT</th><th style="width:8%"></th></tr>
        </thead>
        <tbody>
          <tr>
            <td><input class="desc" placeholder="e.g. Web Design Service" /></td>
            <td><input class="qty" type="number" min="1" value="1" /></td>
            <td><input class="price" type="number" step="0.01" value="0.00" /></td>
            <td class="row-total" style="text-align:right">0.00</td>
            <td class="row-actions"><button class="remove-row" title="Remove">âœ–</button></td>
          </tr>
        </tbody>
      </table>

      <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
        <div style="display:flex;gap:8px;align-items:center">
          <button class="add-line" id="addLineSecondary">+ Yeni SatÄ±r (Premium)</button>
          <small style="color:var(--muted)">Logo, limitsiz satÄ±r ve watermark kaldÄ±rma iÃ§in Premium</small>
        </div>

        <div class="totals" aria-hidden="false">
          <div class="row"><div>Subtotal:</div><div id="subtotal">0.00 USD</div></div>
          <div class="row"><div>Tax (<span id="taxLabel">0</span> %):</div><div id="taxAmount">0.00 USD</div></div>
          <div class="grand"><div>TOTAL</div><div id="grandTotal">0.00 USD</div></div>
        </div>
      </div>

      <div class="bottom">
        <div style="color:var(--muted)">Professional Invoice Generator</div>
        <div class="actions">
          <button class="btn btn-outline" id="saveBtn">Kaydet (Local)</button>
          <button class="btn btn-primary" id="downloadBtn">ðŸ“„ Download PDF</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Phone Fullscreen Overlay -->
  <div id="phoneOverlay" role="dialog" aria-modal="true">
    <div class="num" id="overlayNumber"></div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-primary" id="copyPhoneBtn">Kopyala</button>
      <button class="btn btn-outline" id="closeOverlayBtn">Kapat</button>
    </div>
    <div class="hint" style="margin-top:18px;font-size:14px;opacity:.85">Bu gÃ¶rÃ¼nÃ¼m hem mobil hem masaÃ¼stÃ¼nde tam ekran gÃ¶sterim iÃ§in optimize edilmiÅŸtir.</div>
  </div>

  <!-- Payment Modal (simÃ¼le/replace with real gateway) -->
  <div id="paymentModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pmTitle">
      <h3 id="pmTitle">Go Premium</h3>
      <p style="color:var(--muted);margin:6px 0 12px 0">Unlock: Custom Logo, Unlimited Line Items, No Watermark and more.</p>

      <div style="display:flex;gap:8px;margin-bottom:12px">
        <button class="btn btn-primary" id="payWithCardBtn">Kredi KartÄ± ile Ã–de (Demo)</button>
        <a class="btn btn-outline" id="externalPayLink" target="_blank" rel="noopener" style="display:inline-flex;align-items:center" href="#">GerÃ§ek Ã–deme (Entegrasyon iÃ§in link)</a>
      </div>

      <div id="cardForm" style="display:none;margin-top:8px">
        <div style="font-size:13px;color:var(--muted);margin-bottom:6px">Kart Bilgileri (Demo): Herhangi geÃ§erli gÃ¶rÃ¼nen kartÄ± kullanabilirsiniz. GerÃ§ek uygulamada backend gereklidir.</div>
        <input id="cardNumber" placeholder="Kart NumarasÄ± (16 hane)" maxlength="19">
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="cardExp" placeholder="MM/YY" style="flex:1">
          <input id="cardCvc" placeholder="CVC" style="width:120px">
        </div>
        <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
          <button class="btn btn-outline" id="cancelPay">Ä°ptal</button>
          <button class="btn btn-primary" id="confirmPay">Ã–de ve AktifleÅŸtir</button>
        </div>
        <div id="payMsg" style="margin-top:10px;color:#ff5864;display:none"></div>
      </div>

      <div style="margin-top:14px;font-size:13px;color:var(--muted)">
        <label style="display:flex;gap:8px;align-items:center"><input id="demoActivate" type="checkbox"> Demo olarak premium'u hemen aktifleÅŸtir (gÃ¼venli, kart bilgisi gerekmez)</label>
      </div>
    </div>
  </div>

<script>
  // SETTINGS
  const PAYMENT_LINK = "https://your-stripe-or-paddle-or-gumroad-link-here"; // Replace with real checkout link
  let isPremium = JSON.parse(localStorage.getItem('vi_isPremium') || 'false');
  let logoData = localStorage.getItem('vi_logo') || null;

  // ELEMENTS
  const invoiceDateEl = document.getElementById('invoiceDate');
  const taxRateEl = document.getElementById('taxRate');
  const currencyEl = document.getElementById('currency');
  const subtotalEl = document.getElementById('subtotal');
  const taxAmountEl = document.getElementById('taxAmount');
  const taxLabelEl = document.getElementById('taxLabel');
  const grandTotalEl = document.getElementById('grandTotal');
  const itemsTable = document.getElementById('itemsTable').querySelector('tbody');
  const logoArea = document.getElementById('logoArea');
  const logoInput = document.getElementById('logoInput');
  const logoPreview = document.getElementById('logoPreview');
  const logoPlaceholder = document.getElementById('logoPlaceholder');
  const addLineBtn = document.getElementById('addLineBtn');
  const addLineSecondary = document.getElementById('addLineSecondary');
  const downloadBtn = document.getElementById('downloadBtn');
  const activatePremiumBtn = document.getElementById('activatePremiumBtn');
  const paymentModal = document.getElementById('paymentModal');
  const payWithCardBtn = document.getElementById('payWithCardBtn');
  const cardForm = document.getElementById('cardForm');
  const demoActivate = document.getElementById('demoActivate');
  const externalPayLink = document.getElementById('externalPayLink');
  const saveBtn = document.getElementById('saveBtn');
  const showCompanyPhoneBtn = document.getElementById('showCompanyPhoneBtn');
  const showClientPhoneBtn = document.getElementById('showClientPhoneBtn');
  const phoneOverlay = document.getElementById('phoneOverlay');
  const overlayNumber = document.getElementById('overlayNumber');
  const copyPhoneBtn = document.getElementById('copyPhoneBtn');
  const closeOverlayBtn = document.getElementById('closeOverlayBtn');
  const toggleFullscreenBtn = document.getElementById('toggleFullscreenBtn');
  const invoiceCard = document.getElementById('invoiceCard');

  // Init date
  if (invoiceDateEl) invoiceDateEl.valueAsDate = new Date();

  // Load logo if exists
  function restoreLogo() {
    if (logoData) {
      logoPreview.src = logoData;
      logoPreview.style.display = 'block';
      logoPlaceholder.style.display = 'none';
    } else {
      logoPreview.style.display = 'none';
      logoPlaceholder.style.display = 'flex';
    }
  }
  restoreLogo();

  // Premium state handling
  function updatePremiumUI() {
    if (isPremium) {
      document.getElementById('logoBadge').textContent = '(Active)';
      addLineSecondary.textContent = '+ Yeni SatÄ±r';
      addLineSecondary.style.background = '#e8fff7';
      addLineSecondary.style.border = '1px solid #c8f0e8';
      logoPlaceholder.querySelector('.logo-text').textContent = 'Logo ekle';
      logoPlaceholder.querySelector('.logo-badge').textContent = '(Premium)';
      logoArea.title = 'Logo ekle';
      activatePremiumBtn.textContent = 'Premium (aktif)';
      activatePremiumBtn.disabled = true;
    } else {
      document.getElementById('logoBadge').textContent = '(Premium)';
      addLineSecondary.textContent = '+ Yeni SatÄ±r (Premium)';
      logoArea.title = 'Logo (Premium)';
      activatePremiumBtn.textContent = 'Premium AktifleÅŸtir';
      activatePremiumBtn.disabled = false;
    }
  }
  updatePremiumUI();

  // ---------- Items handling ----------
  function recalc() {
    let subtotal = 0;
    itemsTable.querySelectorAll('tr').forEach(tr => {
      const qty = parseFloat(tr.querySelector('.qty').value) || 0;
      const price = parseFloat(tr.querySelector('.price').value) || 0;
      const amount = qty * price;
      const totalCell = tr.querySelector('.row-total');
      totalCell.textContent = amount.toFixed(2);
      subtotal += amount;
    });
    const taxRate = parseFloat(taxRateEl.value) || 0;
    const tax = subtotal * (taxRate / 100);
    const total = subtotal + tax;
    const cur = currencyEl.value || '';
    taxLabelEl.textContent = taxRate;
    subtotalEl.textContent = subtotal.toFixed(2) + ' ' + cur;
    taxAmountEl.textContent = tax.toFixed(2) + ' ' + cur;
    grandTotalEl.textContent = total.toFixed(2) + ' ' + cur;
  }

  // Add row (premium enforced)
  function addRow(auto=false) {
    if (!isPremium && !auto) {
      openPaymentModal('line'); return;
    }
    const template = itemsTable.querySelector('tr');
    const row = template.cloneNode(true);
    row.querySelectorAll('input').forEach(inp => {
      if (inp.classList.contains('qty')) inp.value = 1;
      else if (inp.classList.contains('price')) inp.value = 0;
      else if (inp.classList.contains('desc')) inp.value = '';
    });
    row.querySelector('.row-total').textContent = '0.00';
    itemsTable.appendChild(row);
    attachRowEvents(row);
    recalc();
  }

  function attachRowEvents(row) {
    row.querySelectorAll('.qty, .price').forEach(inp => inp.addEventListener('input', recalc));
    const removeBtn = row.querySelector('.remove-row');
    if (removeBtn) {
      removeBtn.addEventListener('click', () => {
        // Keep at least one row
        if (itemsTable.querySelectorAll('tr').length > 1) {
          row.remove();
          recalc();
        } else {
          // clear fields instead
          row.querySelectorAll('input').forEach(i => {
            if (i.classList.contains('qty')) i.value = 1;
            else i.value = '';
          });
          row.querySelector('.row-total').textContent = '0.00';
          recalc();
        }
      });
    }
  }

  // Attach to existing
  itemsTable.querySelectorAll('tr').forEach(tr => attachRowEvents(tr));

  // Buttons
  addLineBtn.addEventListener('click', () => addRow(false));
  addLineSecondary.addEventListener('click', () => addRow(false));

  // enable add via keyboard ENTER on last row description
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.target && e.target.classList && e.target.classList.contains('desc')) {
      e.preventDefault();
      addRow(true);
    }
  });

  // ---------- Logo handling ----------
  logoArea.addEventListener('click', () => {
    if (!isPremium) { openPaymentModal('logo'); return; }
    logoInput.click();
  });

  logoInput.addEventListener('change', (ev) => {
    const f = ev.target.files && ev.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      logoData = e.target.result;
      localStorage.setItem('vi_logo', logoData);
      restoreLogo();
    };
    reader.readAsDataURL(f);
  });

  // ---------- Payment Modal / Activation ----------
  activatePremiumBtn.addEventListener('click', () => openPaymentModal());

  function openPaymentModal(feature){
    paymentModal.classList.add('show');
    paymentModal.setAttribute('aria-hidden', 'false');
    // if opening because of feature, highlight
    // show external link and card form toggle
    externalPayLink.href = PAYMENT_LINK;
  }

  // Payment UI controls
  payWithCardBtn.addEventListener('click', () => {
    cardForm.style.display = cardForm.style.display === 'none' ? 'block' : 'none';
  });
  document.getElementById('cancelPay').addEventListener('click', () => {
    cardForm.style.display = 'none';
  });

  // Demo activation checkbox (quick)
  demoActivate.addEventListener('change', (e) => {
    if (e.target.checked) {
      // immediate demo activation
      isPremium = true;
      localStorage.setItem('vi_isPremium', 'true');
      paymentModal.classList.remove('show');
      paymentModal.setAttribute('aria-hidden', 'true');
      updatePremiumUI();
      recalc();
      alert('Premium demo modu aktif. Bu gerÃ§ek Ã¶deme deÄŸildir.');
    }
  });

  // Simulate card payment validation (DEMO ONLY)
  document.getElementById('confirmPay').addEventListener('click', () => {
    const num = document.getElementById('cardNumber').value.replace(/\s+/g,'');
    const exp = document.getElementById('cardExp').value.trim();
    const cvc = document.getElementById('cardCvc').value.trim();
    const payMsg = document.getElementById('payMsg');
    // minimal checks
    if (!luhnCheck(num) || num.length < 12) { payMsg.style.display='block'; payMsg.textContent='Kart numarasÄ± geÃ§erli deÄŸil.'; return; }
    if (!/^\d{2}\/\d{2}$/.test(exp)) { payMsg.style.display='block'; payMsg.textContent='GeÃ§ersiz tarih formatÄ± (MM/YY).'; return; }
    if (!/^\d{3,4}$/.test(cvc)) { payMsg.style.display='block'; payMsg.textContent='CVC geÃ§erli deÄŸil.'; return; }
    payMsg.style.display='none';

    // Simulate success
    setTimeout(() => {
      isPremium = true;
      localStorage.setItem('vi_isPremium','true');
      paymentModal.classList.remove('show');
      paymentModal.setAttribute('aria-hidden','true');
      updatePremiumUI();
      alert('Premium baÅŸarÄ±yla aktifleÅŸtirildi (demo). GerÃ§ek uygulamada backend doÄŸrulamasÄ± gereklidir.');
    }, 700);
  });

  // Luhn check for demo validation
  function luhnCheck(val){
    let sum = 0; let alt = false; for (let i = val.length - 1; i >= 0; i--) {
      if (isNaN(parseInt(val[i],10))) return false;
      let num = parseInt(val[i],10);
      if (alt) { num *= 2; if (num > 9) num -= 9; }
      sum += num; alt = !alt;
    }
    return (sum % 10) === 0;
  }

  // ---------- PDF Generation ----------
  function generatePDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' });
    const pageW = doc.internal.pageSize.getWidth();
    const left = 40; let y = 50;
    const companyName = document.getElementById('companyName').value || '';
    const companyAddress = document.getElementById('companyAddress').value || '';
    const companyPhone = document.getElementById('companyPhone').value || '';
    const clientInfo = document.getElementById('clientInfo').value || '';
    const clientPhone = document.getElementById('clientPhone').value || '';
    const invoiceNo = document.getElementById('invoiceNo').value || '';
    const invoiceDate = document.getElementById('invoiceDate').value || '';
    const cur = currencyEl.value || '';

    // Logo
    if (isPremium && logoData) {
      try { doc.addImage(logoData, 'PNG', left, y, 120, 60); } catch(e){ console.warn('Logo add failed', e); }
    }

    // Company right aligned
    doc.setFontSize(18); doc.setTextColor(16,98,254);
    doc.text(companyName, pageW - left, y + 12, { align: 'right' });
    doc.setFontSize(10); doc.setTextColor(90);
    const companyLines = doc.splitTextToSize(companyAddress, 220);
    doc.text(companyLines, pageW - left, y + 32, { align: 'right' });
    if (document.getElementById('showCompanyPhoneOnPdf').checked && companyPhone) {
      doc.text('Tel: ' + companyPhone, pageW - left, y + 32 + companyLines.length*12 + 6, { align: 'right' });
    }

    // Bill to
    y += 110;
    doc.setFontSize(11); doc.setTextColor(10);
    doc.text('BILL TO:', left, y);
    const clientLines = doc.splitTextToSize(clientInfo, 220);
    doc.text(clientLines, left, y + 14);
    if (document.getElementById('showClientPhoneOnPdf').checked && clientPhone) {
      doc.text('Tel: ' + clientPhone, left, y + 16 + clientLines.length*12);
    }

    // Invoice meta
    doc.setFontSize(10); doc.text('INVOICE NO:', pageW - 220, y);
    doc.text(invoiceNo, pageW - left, y, { align:'right' });
    doc.text('DATE:', pageW - 220, y + 18);
    doc.text(invoiceDate, pageW - left, y + 18, { align:'right' });

    // Table header
    y += 80;
    doc.setFillColor(249,250,252);
    doc.rect(left, y - 12, pageW - left*2, 18, 'F');
    doc.setFontSize(11); doc.setFont('helvetica','bold'); doc.setTextColor(48,64,84);
    doc.text('DESCRIPTION', left + 6, y);
    doc.text('QTY', left + 280, y, { align: 'center' });
    doc.text('PRICE', left + 340, y, { align: 'center' });
    doc.text('AMOUNT', pageW - left, y, { align: 'right' });

    // Rows
    y += 16; doc.setFont('helvetica','normal'); doc.setTextColor(20);
    itemsTable.querySelectorAll('tr').forEach((tr, idx) => {
      const desc = tr.querySelector('.desc').value || '';
      const qty = tr.querySelector('.qty').value || '0';
      const price = (parseFloat(tr.querySelector('.price').value) || 0).toFixed(2) + ' ' + cur;
      const amount = (parseFloat(tr.querySelector('.row-total').textContent) || 0).toFixed(2) + ' ' + cur;

      const descLines = doc.splitTextToSize(desc, 250);
      doc.text(descLines, left + 6, y);
      doc.text(qty.toString(), left + 280, y, { align:'center' });
      doc.text(price, left + 340, y, { align:'center' });
      doc.text(amount, pageW - left, y, { align:'right' });
      y += Math.max(12, descLines.length*12);

      // page break
      if (y > doc.internal.pageSize.getHeight() - 120) { doc.addPage(); y = 60; }
    });

    // Totals
    y += 18;
    doc.setFontSize(11);
    doc.text('Subtotal: ' + subtotalEl.textContent, pageW - left, y, { align:'right' });
    y += 14;
    doc.text('Tax: ' + taxAmountEl.textContent, pageW - left, y, { align:'right' });
    y += 16;
    doc.setFontSize(14); doc.setTextColor(16,98,254); doc.setFont('helvetica','bold');
    doc.text('TOTAL: ' + grandTotalEl.textContent, pageW - left, y, { align:'right' });

    // Watermark if not premium
    if (!isPremium) {
      doc.setFontSize(9); doc.setTextColor(160);
      doc.setFont('helvetica','italic');
      doc.text('Generated with free version of Pro Invoice Generator', pageW / 2, doc.internal.pageSize.getHeight() - 40, { align:'center' });
    }

    const fname = `Invoice-${invoiceNo || 'unnumbered'}.pdf`;
    doc.save(fname);
  }

  // ---------- Fullscreen / Phone overlay ----------
  function openOverlay(number) {
    overlayNumber.textContent = number || '';
    phoneOverlay.classList.add('show');
    phoneOverlay.setAttribute('aria-hidden','false');
    // Try to enter fullscreen for immersive effect
    try {
      document.documentElement.requestFullscreen?.();
    } catch(e){}
  }
  function closeOverlay() {
    phoneOverlay.classList.remove('show');
    phoneOverlay.setAttribute('aria-hidden','true');
    try { document.exitFullscreen?.(); } catch(e){}
  }
  showCompanyPhoneBtn.addEventListener('click', () => {
    const n = document.getElementById('companyPhone').value.trim();
    if (!n) return alert('LÃ¼tfen Ã¶nce ÅŸirket telefonunu girin.');
    openOverlay(n);
  });
  showClientPhoneBtn.addEventListener('click', () => {
    const n = document.getElementById('clientPhone').value.trim();
    if (!n) return alert('LÃ¼tfen Ã¶nce mÃ¼ÅŸteri telefonunu girin.');
    openOverlay(n);
  });
  copyPhoneBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(overlayNumber.textContent || '');
      alert('Numara kopyalandÄ±');
    } catch(e){ alert('Kopyalama baÅŸarÄ±sÄ±z'); }
  });
  closeOverlayBtn.addEventListener('click', closeOverlay);
  phoneOverlay.addEventListener('click', (e) => { if (e.target === phoneOverlay) closeOverlay(); });

  // Fullscreen toggle for invoice card
  toggleFullscreenBtn.addEventListener('click', () => {
    if (!document.fullscreenElement) {
      invoiceCard.requestFullscreen?.().then(()=> invoiceCard.classList.add('fullscreen')).catch(()=> invoiceCard.classList.add('fullscreen'));
    } else {
      document.exitFullscreen?.().then(()=> invoiceCard.classList.remove('fullscreen')).catch(()=> invoiceCard.classList.remove('fullscreen'));
    }
  });
  document.addEventListener('fullscreenchange', ()=> {
    if (!document.fullscreenElement) invoiceCard.classList.remove('fullscreen');
  });

  // ---------- Save / Restore local ----------
  function saveState() {
    const state = {
      companyName: document.getElementById('companyName').value,
      companyAddress: document.getElementById('companyAddress').value,
      companyPhone: document.getElementById('companyPhone').value,
      clientInfo: document.getElementById('clientInfo').value,
      clientPhone: document.getElementById('clientPhone').value,
      invoiceNo: document.getElementById('invoiceNo').value,
      invoiceDate: document.getElementById('invoiceDate').value,
      currency: currencyEl.value,
      taxRate: taxRateEl.value,
      items: Array.from(itemsTable.querySelectorAll('tr')).map(tr => ({
        desc: tr.querySelector('.desc').value,
        qty: tr.querySelector('.qty').value,
        price: tr.querySelector('.price').value
      })),
      isPremium: isPremium,
      logo: logoData
    };
    localStorage.setItem('vi_state', JSON.stringify(state));
    localStorage.setItem('vi_isPremium', JSON.stringify(isPremium));
    if (logoData) localStorage.setItem('vi_logo', logoData);
    alert('Fatura verisi yerel olarak kaydedildi.');
  }
  function restoreState(){
    const s = JSON.parse(localStorage.getItem('vi_state') || 'null');
    if (!s) return;
    document.getElementById('companyName').value = s.companyName || '';
    document.getElementById('companyAddress').value = s.companyAddress || '';
    document.getElementById('companyPhone').value = s.companyPhone || '';
    document.getElementById('clientInfo').value = s.clientInfo || '';
    document.getElementById('clientPhone').value = s.clientPhone || '';
    document.getElementById('invoiceNo').value = s.invoiceNo || '';
    document.getElementById('invoiceDate').value = s.invoiceDate || '';
    currencyEl.value = s.currency || 'USD';
    taxRateEl.value = s.taxRate || 0;
    // items
    const rows = s.items || [];
    // clear existing
    itemsTable.innerHTML = '';
    if (rows.length === 0) rows.push({desc:'',qty:1,price:0});
    rows.forEach(it => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><input class="desc" value="${escapeHtml(it.desc || '')}" /></td>
        <td><input class="qty" type="number" min="1" value="${it.qty || 1}" /></td>
        <td><input class="price" type="number" step="0.01" value="${it.price || 0}" /></td>
        <td class="row-total" style="text-align:right">0.00</td>
        <td class="row-actions"><button class="remove-row" title="Remove">âœ–</button></td>`;
      itemsTable.appendChild(tr);
      attachRowEvents(tr);
    });
    logoData = s.logo || logoData;
    restoreLogo();
    isPremium = !!s.isPremium;
    updatePremiumUI();
    recalc();
  }
  saveBtn.addEventListener('click', saveState);

  // Download PDF
  downloadBtn.addEventListener('click', generatePDF);

  // Attach recalc events
  taxRateEl.addEventListener('input', recalc);
  currencyEl.addEventListener('change', recalc);

  // Initial
  recalc();
  restoreState();

  // Utility: escape HTML for inputs restoration
  function escapeHtml(text) {
    return String(text).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // Close payment modal on outside click
  paymentModal.addEventListener('click', (e) => {
    if (e.target === paymentModal) {
      paymentModal.classList.remove('show');
      paymentModal.setAttribute('aria-hidden','true');
    }
  });

  // Accessibility: ensure keyboard close for overlays
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      paymentModal.classList.remove('show');
      paymentModal.setAttribute('aria-hidden','true');
      closeOverlay();
    }
  });
</script>
</body>
</html>